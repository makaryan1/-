
{% extends "base.html" %}

{% block title %}Панель курьера - Цветочный рай{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary"><i class="fas fa-truck text-warning"></i> Панель курьера</h2>
    <div>
        <span class="badge bg-warning text-dark me-2 px-3 py-2">
            <i class="fas fa-user"></i> {{ session.courier_username or session.admin_username }}
        </span>
        <a href="{{ url_for('courier_logout') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-sign-out-alt"></i> Выйти
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-info text-white shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>Новые заказы</h6>
                        <h3>{{ orders|selectattr('status', 'equalto', 'Новый')|list|length }}</h3>
                    </div>
                    <i class="fas fa-plus-circle fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>К доставке</h6>
                        <h3>{{ orders|selectattr('status', 'equalto', 'Готов к доставке')|list|length }}</h3>
                    </div>
                    <i class="fas fa-truck fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>В пути</h6>
                        <h3>{{ orders|selectattr('status', 'equalto', 'В пути')|list|length }}</h3>
                    </div>
                    <i class="fas fa-shipping-fast fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>Доставлено</h6>
                        <h3>{{ orders|selectattr('status', 'equalto', 'Доставлен')|list|length }}</h3>
                    </div>
                    <i class="fas fa-check-circle fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="fas fa-list"></i> Заказы для доставки</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="ordersTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Клиент</th>
                        <th>Адрес</th>
                        <th>Телефон</th>
                        <th>Сумма</th>
                        <th>Оплата</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td><strong>#{{ order.id }}</strong></td>
                        <td>{{ order.name }}</td>
                        <td>
                            <small>{{ order.address }}</small>
                            <br>
                            <span class="badge bg-secondary">{{ order.delivery_area }}</span>
                        </td>
                        <td>
                            <a href="tel:{{ order.phone }}" class="text-decoration-none">
                                <i class="fas fa-phone text-success"></i> {{ order.phone }}
                            </a>
                        </td>
                        <td><strong>{{ order.total }} ₾</strong></td>
                        <td>
                            <span class="badge 
                                {% if order.payment_status == 'paid' %}bg-success
                                {% elif order.payment_status == 'cash_on_delivery' %}bg-warning
                                {% elif order.payment_status == 'failed' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {% if order.payment_status == 'paid' %}
                                    <i class="fas fa-credit-card"></i> Оплачено
                                {% elif order.payment_status == 'cash_on_delivery' %}
                                    <i class="fas fa-money-bill-wave"></i> Наличными
                                {% elif order.payment_status == 'failed' %}
                                    <i class="fas fa-exclamation-triangle"></i> Ошибка
                                {% else %}
                                    <i class="fas fa-clock"></i> Ожидает
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge fs-6
                                {% if order.status == 'Новый' %}bg-info
                                {% elif order.status == 'Готов к доставке' %}bg-warning
                                {% elif order.status == 'В пути' %}bg-primary
                                {% elif order.status == 'Доставлен' %}bg-success
                                {% else %}bg-secondary{% endif %}">
                                {{ order.status }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                {% if order.status == 'Новый' %}
                                <button class="btn btn-sm btn-warning" onclick="updateStatusWithConfirm({{ order.id }}, 'Готов к доставке')">
                                    <i class="fas fa-truck"></i> К доставке
                                </button>
                                {% elif order.status == 'Готов к доставке' %}
                                <button class="btn btn-sm btn-primary" onclick="updateStatusWithConfirm({{ order.id }}, 'В пути')">
                                    <i class="fas fa-shipping-fast"></i> В пути
                                </button>
                                {% elif order.status == 'В пути' %}
                                <button class="btn btn-sm btn-success" onclick="updateStatusWithConfirm({{ order.id }}, 'Доставлен')">
                                    <i class="fas fa-check"></i> Доставлено
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(255, 193, 7, 0.1);
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.btn-group .btn {
    transition: all 0.3s ease;
}

.btn-group .btn:hover {
    transform: translateY(-2px);
}
</style>

<script>
function updateStatusWithConfirm(orderId, status) {
    const statusMessages = {
        'Готов к доставке': 'пометить заказ как готовый к доставке',
        'В пути': 'начать доставку заказа',
        'Доставлен': 'завершить доставку заказа'
    };
    
    const message = statusMessages[status] || 'изменить статус заказа';
    
    if (confirm(`Вы уверены, что хотите ${message} #${orderId}?`)) {
        updateStatus(orderId, status);
    }
}

function updateStatus(orderId, status) {
    // Показываем индикатор загрузки
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch('/courier/update_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Статус заказа #${orderId} успешно обновлен`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Ошибка при обновлении статуса', 'error');
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    })
    .catch(error => {
        showNotification('Ошибка при обновлении статуса', 'error');
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

// Функция для показа уведомлений
function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'info' ? 'alert-info' : 'alert-warning';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

// Автообновление страницы каждые 30 секунд
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}
