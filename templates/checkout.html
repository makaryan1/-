{% extends "base.html" %}

{% block title %}Оформление заказа - Цветочный рай{% endblock %}

{% block content %}
<h1 class="mb-4">
    <i class="fas fa-credit-card"></i> Оформление заказа
</h1>

{% if not user %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> 
    Авторизуйтесь для более быстрого оформления заказов
    <div class="mt-2">
        <script authed="location.reload()" src="https://auth.util.repl.co/script.js"></script>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <form method="POST" id="checkout-form">
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-user"></i> Контактная информация</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Имя *</label>
                            <input type="text" class="form-control" name="name" 
                                   value="{% if user %}{{ user.name }}{% endif %}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Телефон *</label>
                            <input type="tel" class="form-control" name="phone" 
                                   value="{% if user %}{{ user.phone }}{% endif %}" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" name="email"
                               value="{% if user %}{{ user.email }}{% endif %}">
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-truck"></i> Доставка</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="delivery_area" class="form-label">Выберите область доставки *</label>
                        <select class="form-control" name="delivery_area" id="delivery_area" required onchange="updateDeliveryOptions(); toggleVillageDetails()">
                            <option value="">Выберите область...</option>
                            {% for key, area in delivery_areas.items() %}
                                <option value="{{ key }}" data-price="{{ area.price }}">{{ area.name }} - {{ area.price }} ₾</option>
                            {% endfor %}
                            <option value="village" data-price="10">Деревни около Ахалцихе - 10 ₾</option>
                        </select>
                    </div>

                    <div class="mb-3" id="village-select" style="display: none;">
                        <label for="village" class="form-label">Выберите деревню *</label>
                        <select class="form-control" name="village" id="village">
                            <option value="">Выберите деревню...</option>
                            {% for village in villages %}
                                <option value="{{ village }}">{{ village }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="address" class="form-label">Точный адрес *</label>
                        <textarea class="form-control" name="address" id="address" rows="3" required 
                                  placeholder="Укажите точный адрес для доставки">{% if user %}{{ user.address }}{% endif %}</textarea>
                        <div class="form-text">Для городов Ахалцихе укажите улицу и номер дома для построения маршрута</div>
                    </div>

                    <div id="map-container" style="display: none;" class="mt-3">
                        <div class="alert alert-info">
                            <i class="fas fa-map-marker-alt"></i>
                            <strong>Выберите точное место доставки на карте:</strong>
                        </div>
                        <div id="map" style="height: 300px; border-radius: 15px; overflow: hidden;"></div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()">
                                <i class="fas fa-location-arrow"></i> Моё местоположение
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="searchAddress()">
                                <i class="fas fa-search"></i> Поиск адреса
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Нажмите на карту чтобы выбрать точное место доставки. 
                                Адрес будет автоматически обновлен.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-credit-card"></i> Способ оплаты</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Способ оплаты</label>
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_method" value="cash" id="cash" checked onchange="toggleBankSelection()">
                                <label class="form-check-label" for="cash">
                                    <i class="fas fa-money-bill-wave"></i> Наличными курьеру
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_method" value="card" id="card" onchange="toggleBankSelection()">
                                <label class="form-check-label" for="card">
                                    <i class="fas fa-credit-card"></i> Банковской картой онлайн
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Выбор банка -->
                    <div class="mb-3" id="bank-selection" style="display: none;">
                        <label class="form-label">Выберите банк для оплаты</label>
                        <div class="row">
                            {% for bank in available_banks %}
                            <div class="col-md-6 mb-3">
                                <div class="card bank-card" onclick="selectBank('{{ bank.id }}')">
                                    <div class="card-body text-center">
                                        <img src="{{ bank.logo }}" alt="{{ bank.name }}" class="bank-logo mb-2">
                                        <h6>{{ bank.name }}</h6>
                                        <small class="text-muted">Комиссия: {{ bank.processing_fee }}%</small>
                                        <input type="radio" name="selected_bank" value="{{ bank.id }}" class="bank-radio" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                <a href="{{ url_for('cart') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Вернуться в корзину
                </a>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-check"></i> Подтвердить заказ
                </button>
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Ваш заказ</h5>
            </div>
            <div class="card-body">
                {% for item in cart_items %}
                <div class="d-flex justify-content-between mb-2">
                    <span>{{ item.flower.name }} x{{ item.quantity }}</span>
                    <span>{{ item.total }} ₾</span>
                </div>
                {% endfor %}
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Товары:</span>
                    <span>{{ cart_total }} ₾</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Доставка:</span>
                    <span id="delivery-price">0 ₾</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Итого:</span>
                    <span class="text-primary" id="total-price">{{ cart_total }} ₾</span>
                </div>
                <hr>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Способ оплаты будет указан при оформлении заказа
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dkmvuFiYMaplvE&libraries=places&callback=initMap" async defer></script>

<script>
let map;
let marker;
let geocoder;
let placesService;

function initMap() {
    // Координаты Ахалцихе
    const akhaltsikhe = { lat: 41.6394, lng: 42.9802 };

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14,
        center: akhaltsikhe,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
        styles: [
            {
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "on" }]
            }
        ]
    });

    geocoder = new google.maps.Geocoder();
    placesService = new google.maps.places.PlacesService(map);

    // Создаем маркер
    marker = new google.maps.Marker({
        position: akhaltsikhe,
        map: map,
        draggable: true,
        title: 'Место доставки'
    });

    // Обработчик клика по карте
    map.addListener('click', function(event) {
        updateMarkerPosition(event.latLng);
        reverseGeocode(event.latLng);
    });

    // Обработчик перетаскивания маркера
    marker.addListener('dragend', function(event) {
        reverseGeocode(event.latLng);
    });
}

function updateMarkerPosition(position) {
    marker.setPosition(position);
    map.panTo(position);
}

function reverseGeocode(latLng) {
    geocoder.geocode({ location: latLng }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const addressComponents = results[0].address_components;
            let formattedAddress = results[0].formatted_address;

            // Убираем "Georgia" из адреса для краткости
            formattedAddress = formattedAddress.replace(', Georgia', '');

            document.getElementById('address').value = formattedAddress;
        }
    });
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            updateMarkerPosition(pos);
            reverseGeocode(pos);
            map.setZoom(16);
        }, function(error) {
            alert('Не удалось получить ваше местоположение: ' + error.message);
        });
    } else {
        alert('Геолокация не поддерживается вашим браузером');
    }
}

function searchAddress() {
    const searchQuery = prompt('Введите адрес для поиска:');
    if (searchQuery) {
        geocoder.geocode({ address: searchQuery + ', Ахалцихе, Грузия' }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const location = results[0].geometry.location;
                updateMarkerPosition(location);
                reverseGeocode(location);
                map.setZoom(16);
            } else {
                alert('Адрес не найден. Попробуйте другой запрос.');
            }
        });
    }
}

function updateDeliveryOptions() {
    const deliveryArea = document.getElementById('delivery_area');
    const villageSelect = document.getElementById('village-select');
    const deliveryPriceSpan = document.getElementById('delivery-price');
    const totalPriceSpan = document.getElementById('total-price');
    const mapContainer = document.getElementById('map-container');

    const cartTotal = {{ cart_total }};
    let deliveryPrice = 0;

    if (deliveryArea.value === 'village') {
        villageSelect.style.display = 'block';
        deliveryPrice = 10;
        mapContainer.style.display = 'none';
    } else if (deliveryArea.value) {
        villageSelect.style.display = 'none';
        const selectedOption = deliveryArea.options[deliveryArea.selectedIndex];
        deliveryPrice = parseInt(selectedOption.dataset.price) || 0;

        if (deliveryArea.value === 'akhaltsikhe') {
            mapContainer.style.display = 'block';
            // Перезагружаем карту если она была скрыта
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter({ lat: 41.6394, lng: 42.9802 });
                }
            }, 100);
        } else {
            mapContainer.style.display = 'none';
        }
    } else {
        villageSelect.style.display = 'none';
        mapContainer.style.display = 'none';
    }

    deliveryPriceSpan.textContent = deliveryPrice + ' ₾';
    totalPriceSpan.textContent = (cartTotal + deliveryPrice) + ' ₾';
}

// Обработка изменения способа оплаты
document.addEventListener('DOMContentLoaded', function() {
    updateDeliveryOptions();
    toggleVillageDetails(); // Initial call to set village select visibility

    const paymentCash = document.getElementById('cash');
    const paymentCard = document.getElementById('card');
    // Removed the duplicate cardPaymentInfo variable and its logic as it's now handled by toggleBankSelection

    // Initial call to set bank selection visibility
    toggleBankSelection();
});

function toggleBankSelection() {
    const cardOption = document.getElementById('card');
    const bankSelection = document.getElementById('bank-selection');

    if (cardOption.checked) {
        bankSelection.style.display = 'block';
        // Выбираем первый банк по умолчанию
        const firstBankRadio = document.querySelector('.bank-radio');
        if (firstBankRadio) {
            firstBankRadio.checked = true;
            // Find the parent card and add the 'selected' class
            const parentCard = firstBankRadio.closest('.bank-card');
            if (parentCard) {
                document.querySelectorAll('.bank-card').forEach(card => card.classList.remove('selected'));
                parentCard.classList.add('selected');
            }
        }
    } else {
        bankSelection.style.display = 'none';
    }
}

function selectBank(bankId) {
    // Убираем выделение со всех карточек банков
    document.querySelectorAll('.bank-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Выделяем выбранную карточку
    event.currentTarget.classList.add('selected');

    // Отмечаем соответствующий radio button
    const bankRadio = document.querySelector(`input[value="${bankId}"]`);
    if (bankRadio) {
        bankRadio.checked = true;
    }
}

// Показать/скрыть детали деревни
function toggleVillageDetails() {
    const deliveryArea = document.getElementById('delivery_area').value;
    const villageSelect = document.getElementById('village-select');

    if (deliveryArea === 'village') {
        villageSelect.style.display = 'block';
    } else {
        villageSelect.style.display = 'none';
    }
}
</script>

<style>
.bank-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
}

.bank-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.bank-card.selected {
    border-color: #28a745;
    background-color: #f8fff9;
}

.bank-logo {
    width: 80px;
    height: 40px;
    object-fit: contain;
}

.bank-radio {
    display: none !important;
}
</style>

{% endblock %}