{% extends "base.html" %}

{% block title %}Оформление заказа - Цветочный рай{% endblock %}

{% block content %}
<h1 class="mb-4">
    <i class="fas fa-credit-card"></i> Оформление заказа
</h1>

{% if not user %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> 
    Авторизуйтесь для более быстрого оформления заказов
    <div class="mt-2">
        <script authed="location.reload()" src="https://auth.util.repl.co/script.js"></script>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <form method="POST" id="checkout-form">
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-user"></i> Контактная информация</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Имя *</label>
                            <input type="text" class="form-control" name="name" 
                                   value="{% if user %}{{ user.name }}{% endif %}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Телефон *</label>
                            <input type="tel" class="form-control" name="phone" 
                                   value="{% if user %}{{ user.phone }}{% endif %}" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" name="email"
                               value="{% if user %}{{ user.email }}{% endif %}">
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-truck"></i> Доставка</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="delivery_area" class="form-label">Выберите область доставки *</label>
                        <select class="form-control" name="delivery_area" id="delivery_area" required onchange="updateDeliveryOptions(); toggleVillageDetails()">
                            <option value="">Выберите область...</option>
                            {% for key, area in delivery_areas.items() %}
                                <option value="{{ key }}" data-price="{{ area.price }}">{{ area.name }} - {{ area.price }} ₾</option>
                            {% endfor %}
                            <option value="village" data-price="10">Деревни около Ахалцихе - 10 ₾</option>
                        </select>
                    </div>

                    <div class="mb-3" id="village-select" style="display: none;">
                        <label for="village" class="form-label">Выберите деревню *</label>
                        <select class="form-control" name="village" id="village">
                            <option value="">Выберите деревню...</option>
                            {% for village in villages %}
                                <option value="{{ village }}">{{ village }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="address" class="form-label">Точный адрес *</label>
                        <textarea class="form-control" name="address" id="address" rows="3" required 
                                  placeholder="Укажите точный адрес для доставки">{% if user %}{{ user.address }}{% endif %}</textarea>
                        <div class="form-text">Для городов Ахалцихе укажите улицу и номер дома для построения маршрута</div>
                    </div>

                    <div id="map-container" style="display: none;" class="mt-3">
                        <div class="alert alert-info">
                            <i class="fas fa-map-marker-alt"></i>
                            <strong>Выберите точное место доставки на карте:</strong>
                        </div>
                        <div id="map" style="height: 300px; border-radius: 15px; overflow: hidden;"></div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()">
                                <i class="fas fa-location-arrow"></i> Моё местоположение
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="searchAddress()">
                                <i class="fas fa-search"></i> Поиск адреса
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Нажмите на карту чтобы выбрать точное место доставки. 
                                Адрес будет автоматически обновлен.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-credit-card"></i> Способ оплаты</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Способ оплаты</label>
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_method" value="cash" id="cash" checked onchange="toggleBankSelection()">
                                <label class="form-label" for="cash">
                                    <i class="fas fa-money-bill-wave"></i> Наличными курьеру
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_method" id="card" value="card" required onchange="toggleBankSelection()">
                                <label class="form-label" for="card">
                                    <i class="fas fa-credit-card text-primary"></i> Банковская карта
                                </label>
                                <div id="bank-selection" class="mt-3" style="display: none;">
                                    <label class="form-label">Выберите банк:</label>
                                    <div class="row">
                                        {% for bank in available_banks %}
                                        <div class="col-md-6 mb-2">
                                            <div class="card bank-card" data-bank-id="{{ bank.id }}">
                                                <div class="card-body p-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="selected_bank" 
                                                               id="bank_{{ bank.id }}" value="{{ bank.id }}" 
                                                               {% if loop.first %}checked{% endif %}>
                                                        <label class="form-check-label d-flex align-items-center" for="bank_{{ bank.id }}">
                                                            <img src="{{ bank.logo }}" alt="{{ bank.name }}" 
                                                                 style="width: 30px; height: 20px; object-fit: cover; margin-right: 10px;">
                                                            <div>
                                                                <strong>{{ bank.name }}</strong>
                                                                <br>
                                                                <small class="text-muted">Комиссия: {{ bank.processing_fee }}%</small>
                                                            </div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="alert alert-info mt-2">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Внимание:</strong> При оплате картой будет взиматься комиссия банка в размере от 2% до 3%.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                <a href="{{ url_for('cart') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Вернуться в корзину
                </a>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-check"></i> Подтвердить заказ
                </button>
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Ваш заказ</h5>
            </div>
            <div class="card-body">
                {% for item in cart_items %}
                <div class="d-flex justify-content-between mb-2">
                    <span>{{ item.flower.name }} x{{ item.quantity }}</span>
                    <span>{{ item.total }} ₾</span>
                </div>
                {% endfor %}
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Товары:</span>
                    <span>{{ cart_total }} ₾</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Доставка:</span>
                    <span id="delivery-price">0 ₾</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Итого:</span>
                    <span class="text-primary" id="total-price">{{ cart_total }} ₾</span>
                </div>
                <hr>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Способ оплаты будет указан при оформлении заказа
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Карта будет добавлена позже -->
<script>
// Временно отключаем Google Maps для избежания ошибок
function initMap() {
    console.log('Карта будет добавлена в будущих обновлениях');
}
</script>

<style>
.bank-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #dee2e6;
}

.bank-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.bank-card.border-primary {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.05);
}

.payment-summary {
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
}
</style>

<script>
function updateDeliveryOptions() {
    const deliveryArea = document.getElementById('delivery_area');
    const villageSelect = document.getElementById('village-select');
    const deliveryPriceSpan = document.getElementById('delivery-price');
    const totalPriceSpan = document.getElementById('total-price');
    const mapContainer = document.getElementById('map-container');

    const cartTotal = {{ cart_total }};
    let deliveryPrice = 0;

    if (deliveryArea.value === 'village') {
        villageSelect.style.display = 'block';
        deliveryPrice = 10;
        mapContainer.style.display = 'none';
    } else if (deliveryArea.value) {
        villageSelect.style.display = 'none';
        const selectedOption = deliveryArea.options[deliveryArea.selectedIndex];
        deliveryPrice = parseInt(selectedOption.dataset.price) || 0;

        if (deliveryArea.value === 'akhaltsikhe') {
            mapContainer.style.display = 'block';
            // Перезагружаем карту если она была скрыта
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter({ lat: 41.6394, lng: 42.9802 });
                }
            }, 100);
        } else {
            mapContainer.style.display = 'none';
        }
    } else {
        villageSelect.style.display = 'none';
        mapContainer.style.display = 'none';
    }

    deliveryPriceSpan.textContent = deliveryPrice + ' ₾';
    totalPriceSpan.textContent = (cartTotal + deliveryPrice) + ' ₾';
}

// Обработка изменения способа оплаты
document.addEventListener('DOMContentLoaded', function() {
    updateDeliveryOptions();
    toggleVillageDetails(); // Initial call to set village select visibility

    // Initial call to set bank selection visibility
    toggleBankSelection();
});

function toggleBankSelection() {
    const cardOption = document.getElementById('card');
    const bankSelection = document.getElementById('bank-selection');

    if (cardOption.checked) {
        bankSelection.style.display = 'block';
        // Выбираем первый банк по умолчанию
        const firstBankRadio = document.querySelector('.bank-card .form-check-input');
        if (firstBankRadio) {
            firstBankRadio.checked = true;
            // Find the parent card and add the 'selected' class
            const parentCard = firstBankRadio.closest('.bank-card');
            if (parentCard) {
                document.querySelectorAll('.bank-card').forEach(card => card.classList.remove('selected'));
                parentCard.classList.add('selected');
            }
        }
    } else {
        bankSelection.style.display = 'none';
    }
}

// Function to handle bank card selection
function selectBank(bankId) {
    // Remove 'selected' class from all bank cards
    document.querySelectorAll('.bank-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Add 'selected' class to the clicked bank card
    const clickedCard = document.querySelector(`.bank-card[data-bank-id="${bankId}"]`);
    if (clickedCard) {
        clickedCard.classList.add('selected');
    }

    // Check the corresponding radio button
    const bankRadio = document.getElementById(`bank_${bankId}`);
    if (bankRadio) {
        bankRadio.checked = true;
    }
}

// Показать/скрыть детали деревни
function toggleVillageDetails() {
    const deliveryArea = document.getElementById('delivery_area').value;
    const villageSelect = document.getElementById('village-select');

    if (deliveryArea === 'village') {
        villageSelect.style.display = 'block';
    } else {
        villageSelect.style.display = 'none';
    }
}
</script>

{% endblock %}